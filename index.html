<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journal de Trading Interactif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .nav-title-button {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: #fef08a; 
            background-color: #1f2937;
            border-radius: 0.5rem;
            border: 2px solid #eab308; 
            box-shadow: 0 0 10px rgba(234, 179, 8, 0.4), 0 0 20px rgba(234, 179, 8, 0.2);
            text-shadow: 0 0 5px rgba(234, 179, 8, 0.5);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, color 0.3s ease;
            cursor: pointer;
        }
        .nav-title-button:hover {
             box-shadow: 0 0 15px rgba(234, 179, 8, 0.6), 0 0 30px rgba(234, 179, 8, 0.3);
        }
        .nav-title-active {
            background-color: #FFFFFF; /* White background */
            color: #111827; /* Dark text */
            text-shadow: none;
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.6), 0 0 30px rgba(234, 179, 8, 0.3);
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }
        .asset-card-wrapper {
            position: relative;
        }
        .asset-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .asset-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -2px rgba(59, 130, 246, 0.2);
        }
        .asset-tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            z-index: 10;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .asset-card-wrapper:hover .asset-tooltip, .asset-card-wrapper:focus-within .asset-tooltip {
           visibility: visible;
           opacity: 1;
        }
        .trade-row:hover {
            background-color: #1f2937;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-tp { background-color: #10b981; color: #ffffff; }
        .status-sl { background-color: #ef4444; color: #ffffff; }
        .status-be { background-color: #6b7280; color: #ffffff; }
        .status-en-cours { background-color: #3b82f6; color: #ffffff; }
        .asset-logo {
            object-fit: contain;
            padding: 2px;
        }
    </style>
</head>

<body class="antialiased">
    <div class="min-h-screen p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white tracking-tight">JOURNAL DES TRADES</h1>
        </header>

        <!-- Navigation -->
        <div class="mb-8 flex flex-wrap justify-center items-center gap-4">
            <button id="tab-dashboard" class="nav-title-button nav-title-active">Actifs du Jour</button>
            <button id="tab-journal" class="nav-title-button">Journal de Trading</button>
            <button id="tab-analytics" class="nav-title-button">Analyse & Performance</button>
        </div>

        <main>
            <!-- Dashboard View -->
            <div id="view-dashboard">
                <h3 id="dashboard-title" class="text-xl font-semibold text-white text-center mb-6"></h3>
                <div id="tradable-assets-container" class="mb-10">
                    <h3 class="text-xl font-semibold text-blue-400 mb-4">üìà Actifs potentiellement tradables</h3>
                    <div id="tradable-assets" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4">
                        <!-- Tradable assets will be injected here -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-gray-500 mb-4">üö´ Actifs non-tradables (selon les r√®gles)</h3>
                    <div id="non-tradable-assets" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4">
                        <!-- Non-tradable assets will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Journal View -->
            <div id="view-journal" class="hidden">
                 <div class="flex justify-end mb-6">
                    <button id="add-trade-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        + Ajouter un Trade
                    </button>
                </div>

                <!-- Trades en cours -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
                    <h3 class="text-xl font-semibold text-blue-400 mb-4">‚ñ∂Ô∏è Trades en Cours</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-300">
                            <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Actif</th>
                                    <th scope="col" class="px-6 py-3">Date d'Entr√©e</th>
                                    <th scope="col" class="px-6 py-3">Heure</th>
                                    <th scope="col" class="px-6 py-3">Objectif RR</th>
                                    <th scope="col" class="px-6 py-3">Notes</th>
                                    <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="current-trades-body">
                                <!-- Trades en cours inject√©s ici -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Trades cl√¥tur√©s -->
                 <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-400 mb-4">üìö Historique des Trades</h3>
                     <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-300">
                            <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Actif</th>
                                    <th scope="col" class="px-6 py-3">Date</th>
                                    <th scope="col" class="px-6 py-3">R√©sultat</th>
                                    <th scope="col" class="px-6 py-3">RR Obtenu</th>
                                    <th scope="col" class="px-6 py-3">Notes</th>
                                    <th scope="col" class="px-6 py-3">Image/Analyse</th>
                                    <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="closed-trades-body">
                               <!-- Trades cl√¥tur√©s inject√©s ici -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics View -->
            <div id="view-analytics" class="hidden">
                 <!-- This will hold the main view with the monthly chart -->
                <div id="main-analytics-view">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">
                            <h4 class="text-lg font-medium text-gray-400 mb-2">Taux de R√©ussite</h4>
                            <p id="analytics-winrate" class="text-4xl font-bold text-green-400">0%</p>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">
                            <h4 class="text-lg font-medium text-gray-400 mb-2">Gain Total (en R)</h4>
                            <p id="analytics-total-r" class="text-4xl font-bold text-blue-400">0 R</p>
                        </div>
                         <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">
                            <h4 class="text-lg font-medium text-gray-400 mb-2">RR Moyen Gagnant</h4>
                            <p id="analytics-avg-rr" class="text-4xl font-bold text-white">0</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold text-white mb-4">√âvolution Mensuelle du Capital (en R-multiple)</h3>
                        <p class="text-sm text-gray-400 mb-4">Cliquez sur une barre pour voir le d√©tail du mois.</p>
                        <canvas id="capital-chart"></canvas>
                    </div>
                </div>

                <!-- This new section will hold the detailed monthly view, hidden by default -->
                <div id="monthly-detail-view" class="hidden">
                    <div class="flex items-center mb-6">
                        <button id="back-to-main-analytics" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mr-4">&larr; Retour</button>
                        <h3 id="monthly-detail-title" class="text-2xl font-semibold text-white"></h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">
                            <h4 class="text-lg font-medium text-gray-400 mb-2">Taux de R√©ussite (Mois)</h4>
                            <p id="monthly-analytics-winrate" class="text-4xl font-bold text-green-400">0%</p>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">
                            <h4 class="text-lg font-medium text-gray-400 mb-2">Gain Total (Mois)</h4>
                            <p id="monthly-analytics-total-r" class="text-4xl font-bold text-blue-400">0 R</p>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">
                            <h4 class="text-lg font-medium text-gray-400 mb-2">RR Moyen Gagnant (Mois)</h4>
                            <p id="monthly-analytics-avg-rr" class="text-4xl font-bold text-white">0</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold text-white mb-4">Performance Journali√®re (en R-multiple)</h3>
                        <canvas id="daily-capital-chart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for adding/editing a trade -->
    <div id="trade-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-2xl max-h-screen overflow-y-auto">
            <h2 id="modal-title" class="text-2xl font-bold text-white mb-6">Ajouter un nouveau trade</h2>
            <form id="trade-form">
                <input type="hidden" id="trade-id">
                <input type="hidden" id="trade-image-base64">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="asset-select" class="block text-sm font-medium text-gray-300">Actif</label>
                        <select id="asset-select" name="asset" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-white"></select>
                    </div>
                    <div>
                        <label for="trade-rr" class="block text-sm font-medium text-gray-300">Risk/Reward (RR)</label>
                        <input type="number" step="0.1" id="trade-rr" name="rr" placeholder="Ex: 2.5" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-white">
                    </div>
                     <div>
                        <label for="trade-date" class="block text-sm font-medium text-gray-300">Date</label>
                        <input type="date" id="trade-date" name="date" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-white">
                    </div>
                     <div>
                        <label for="trade-time" class="block text-sm font-medium text-gray-300">Heure</label>
                        <input type="time" id="trade-time" name="time" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-white">
                    </div>
                    <div class="md:col-span-2">
                        <label for="trade-status" class="block text-sm font-medium text-gray-300">Statut</label>
                        <select id="trade-status" name="status" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-white">
                            <option value="en-cours">En Cours</option>
                            <option value="tp">TP</option>
                            <option value="sl">SL</option>
                            <option value="be">BE</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="trade-notes" class="block text-sm font-medium text-gray-300">Notes (Psychologie, Contexte, ...)</label>
                        <textarea id="trade-notes" name="notes" rows="4" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-white"></textarea>
                    </div>
                     <div class="md:col-span-2">
                        <label for="trade-image-file" class="block text-sm font-medium text-gray-300">Image du graphique</label>
                        <input type="file" id="trade-image-file" name="imageFile" accept="image/*" class="mt-1 block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                        <img id="image-preview" src="" alt="Aper√ßu" class="mt-2 rounded-md hidden max-h-48"/>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="cancel-btn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for viewing an image -->
    <div id="image-view-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-4 relative max-w-4xl max-h-[90vh]">
            <button id="close-image-modal-btn" class="absolute -top-2 -right-2 text-white bg-gray-600 rounded-full w-8 h-8 flex items-center justify-center hover:bg-red-500 text-2xl z-10">&times;</button>
            <img id="modal-image-content" src="" alt="Analyse du trade" class="max-w-full max-h-[85vh] object-contain rounded-md"/>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const assetsData = [
                { name: 'XAUUSD', rr: 3, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'], inactiveMonths: ['F√©vrier', 'Mai', 'Juin', 'Septembre', 'Octobre'] },
                { name: 'BTCUSD', rr: 3, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'], inactiveMonths: ['Mars', 'Juin'] },
                { name: 'JP225', rr: 2.5, rebonds: 2, activeDays: ['Mardi', 'Mercredi', 'Jeudi', 'Vendredi'], inactiveMonths: ['Janvier'] },
                { name: 'AAPL', rr: 3, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'], inactiveMonths: ['F√©vrier', 'Avril', 'Mai'] },
                { name: 'USDJPY', rr: 2, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Mercredi'], inactiveMonths: ['Janvier', 'Avril', 'Mai', 'Juillet'] },
                { name: 'NASDAQ', rr: 3, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Jeudi', 'Vendredi'], inactiveMonths: ['F√©vrier', 'Mars', 'Avril', 'Mai', 'Ao√ªt', 'Septembre', 'D√©cembre'] },
                { name: 'NFLX', rr: 5, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Mercredi'], inactiveMonths: ['F√©vrier', 'Juin', 'Novembre'] },
                { name: 'GBPJPY', rr: 3, rebonds: 3, activeDays: ['Lundi', 'Mardi', 'Mercredi'], inactiveMonths: ['Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre'] },
                { name: 'AUDJPY', rr: 3, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'], inactiveMonths: ['Janvier', 'Mars', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre'] },
                { name: 'EURJPY', rr: 2.5, rebonds: 3, activeDays: ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'], inactiveMonths: ['Janvier', 'Mars', 'Juillet'] },
                { name: 'NOC', rr: 1.5, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Vendredi'], inactiveMonths: ['Mai'] },
                { name: 'CADJPY', rr: 3, rebonds: 3, activeDays: ['Mardi', 'Jeudi'], inactiveMonths: ['Juin', 'Juillet', 'Ao√ªt'] },
                { name: 'BKNG', rr: 2.5, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Mercredi'], inactiveMonths: ['Juin', 'Septembre', 'Novembre', 'D√©cembre'] },
                { name: 'AMZN', rr: 2.5, rebonds: 2, activeDays: ['Lundi', 'Mercredi', 'Jeudi', 'Vendredi'], inactiveMonths: ['Janvier', 'Mars', 'Juillet', 'D√©cembre'] },
                { name: 'AMD', rr: 1.5, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Jeudi', 'Vendredi'], inactiveMonths: ['Avril', 'Mai'] },
                { name: 'AMAT', rr: 3, rebonds: 2, activeDays: ['Mardi', 'Jeudi', 'Vendredi'], inactiveMonths: ['Mars', 'Avril', 'Juin'] },
                { name: 'ECL', rr: 5, rebonds: 2, activeDays: ['Mardi', 'Mercredi', 'Jeudi'], inactiveMonths: ['F√©vrier', 'Juillet', 'Octobre', 'D√©cembre'] },
                { name: 'CAT', rr: 5, rebonds: 2, activeDays: ['Mardi', 'Mercredi', 'Jeudi', 'Vendredi'], inactiveMonths: ['F√©vrier', 'Mars', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'D√©cembre'] },
                { name: 'GS', rr: 3, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Jeudi'], inactiveMonths: ['F√©vrier', 'Mars', 'Juin', 'Juillet'] },
                { name: 'ISRG', rr: 4, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Jeudi'], inactiveMonths: ['Avril', 'Ao√ªt', 'Septembre', 'Octobre'] },
                { name: 'BLK', rr: 5, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Vendredi'], inactiveMonths: ['Janvier', 'F√©vrier', 'Mars', 'D√©cembre'] },
                { name: 'CRM', rr: 3, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Mercredi', 'Jeudi'], inactiveMonths: ['Avril', 'F√©vrier', 'Juillet', 'Novembre'] },
                { name: 'BRK.B', rr: 2, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Vendredi'], inactiveMonths: ['Avril', 'Mai', 'Juin', 'Juillet'] },
                { name: 'SPGI', rr: 3, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Vendredi'], inactiveMonths: ['Juillet', 'Ao√ªt', 'Novembre', 'D√©cembre'] },
                { name: 'MSFT', rr: 3, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'], inactiveMonths: ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Septembre'] },
                { name: 'BX', rr: 3, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Mercredi'], inactiveMonths: ['F√©vrier', 'Mai', 'Juin', 'Ao√ªt'] },
                { name: 'AMGN', rr: 4, rebonds: 2, activeDays: ['Mardi', 'Vendredi'], inactiveMonths: ['F√©vrier', 'Mars', 'Septembre'] },
                { name: 'LVMH', rr: 5, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Jeudi'], inactiveMonths: ['F√©vrier', 'D√©cembre'] },
                { name: 'COST', rr: 4, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Vendredi'], inactiveMonths: ['Mars', 'Mai', 'Juillet', 'Septembre'] },
                { name: 'NVDA', rr: 1, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Mercredi', 'Vendredi'], inactiveMonths: ['Mai', 'Juillet', 'Novembre', 'D√©cembre'] },
                { name: 'DHR', rr: 3, rebonds: 2, activeDays: ['Lundi', 'Mercredi', 'Jeudi'], inactiveMonths: ['Mars', 'Mai', 'Juillet', 'Ao√ªt', 'D√©cembre'] },
                { name: 'LRCX', rr: 4, rebonds: 2, activeDays: ['Mercredi', 'Jeudi', 'Vendredi'], inactiveMonths: ['F√©vrier', 'Avril', 'Juin', 'Ao√ªt'] },
                { name: 'NOW', rr: 3, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Mercredi', 'Vendredi'], inactiveMonths: ['Mars', 'Septembre'] },
                { name: 'AEP', rr: 2.5, rebonds: 2, activeDays: ['Mercredi', 'Jeudi', 'Vendredi'], inactiveMonths: ['Avril', 'Mai', 'Juin', 'Ao√ªt'] },
                { name: 'DAX', rr: 2, rebonds: 3, activeDays: ['Mardi', 'Mercredi', 'Jeudi'], inactiveMonths: ['Janvier', 'Juin', 'Ao√ªt', 'Novembre', 'D√©cembre'] },
                { name: 'AVB', rr: 1, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Mercredi'], inactiveMonths: ['F√©vrier', 'Avril', 'Mai', 'Juin', 'Novembre'] },
                { name: 'MU', rr: 2.5, rebonds: 2, activeDays: ['Jeudi', 'Mercredi', 'Vendredi'], inactiveMonths: ['F√©vrier', 'Avril', 'Septembre', 'Octobre'] },
                { name: 'ACN', rr: 3, rebonds: 2, activeDays: ['Mardi', 'Mercredi'], inactiveMonths: ['Mars', 'Avril', 'Juin', 'Octobre'] },
                { name: 'BAC', rr: 3, rebonds: 2, activeDays: ['Mercredi', 'Vendredi'], inactiveMonths: ['Septembre', 'Novembre'] },
                { name: 'TMUS', rr: 4, rebonds: 2, activeDays: ['Lundi', 'Mercredi', 'Vendredi'], inactiveMonths: ['Avril', 'Ao√ªt', 'D√©cembre'] },
                { name: 'ELV', rr: 2, rebonds: 2, activeDays: ['Lundi', 'Mercredi'], inactiveMonths: [] },
                { name: 'SP500', rr: 3, rebonds: 3, activeDays: ['Mardi', 'Jeudi', 'Vendredi'], inactiveMonths: ['Mars', 'Ao√ªt', 'D√©cembre'] },
                { name: 'EUR50', rr: 2.5, rebonds: 3, activeDays: ['Lundi', 'Mardi', 'Mercredi', 'Vendredi'], inactiveMonths: [] },
                { name: 'TSLA', rr: 1.5, rebonds: 2, activeDays: ['Mardi', 'Mercredi', 'Jeudi', 'Vendredi'], inactiveMonths: ['Mai', 'Novembre'] },
                { name: 'ABBV', rr: 4, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Mercredi'], inactiveMonths: ['Ao√ªt'] },
                { name: 'QCOM', rr: 3, rebonds: 2, activeDays: ['Mardi', 'Mercredi', 'Vendredi'], inactiveMonths: ['Janvier', 'Mars', 'Juin', 'Novembre', 'D√©cembre'] },
                { name: 'CHTR', rr: 2.5, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Mercredi', 'Vendredi'], inactiveMonths: [] },
                { name: 'RACE', rr: 3, rebonds: 2, activeDays: ['Lundi', 'Mardi', 'Mercredi', 'Vendredi'], inactiveMonths: [] }
            ];

            const sampleTrades = [
                // Empty array - sample trades have been removed
            ];

            // --- STATE MANAGEMENT ---
            let trades = JSON.parse(localStorage.getItem('tradingJournalTrades')) || sampleTrades;
            let currentView = 'dashboard';
            let capitalChart = null, dailyCapitalChart = null;

            const logoMap = {
                'AAPL': 'https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg',
                'MSFT': 'https://upload.wikimedia.org/wikipedia/commons/4/44/Microsoft_logo.svg',
                'BTCUSD': 'https://upload.wikimedia.org/wikipedia/commons/4/46/Bitcoin.svg',
                'XAUUSD': 'https://www.svgrepo.com/show/475656/gold-bar.svg',
                'AMZN': 'https://upload.wikimedia.org/wikipedia/commons/a/a9/Amazon_logo.svg',
                'NFLX': 'https://upload.wikimedia.org/wikipedia/commons/0/08/Netflix_2015_logo.svg',
                'TSLA': 'https://upload.wikimedia.org/wikipedia/commons/b/bd/Tesla_Motors.svg',
                'NVDA': 'https://upload.wikimedia.org/wikipedia/en/2/21/Nvidia_logo.svg',
                'AMD': 'https://upload.wikimedia.org/wikipedia/commons/7/7c/AMD_Logo.svg',
                'GS': 'https://upload.wikimedia.org/wikipedia/commons/c/cf/Goldman_Sachs_logo.svg',
                'LVMH': 'https://upload.wikimedia.org/wikipedia/commons/1/1c/LVMH-logo.svg',
                'AUDJPY': 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QAiRXhpZgAASUkqAAgAAAABABIBAwABAAAAAQAAABoBBQABAAAAVgAAABsBBQABAAAAXgAAACgBAwABAAAAAgAAADEBAgANAAAAZgAAADIBAgAUAAAAjAAAABMCAwABAAAAAQAAAGmHBAABAAAAnAAAAJoAAACgAAAAAQAAAKAAAAABAAAAR0lNUCAyLjEwLjE4AAAyMDI0OjA3OjEwIDE4OjM5OjE3AEFCQwAAAwAABJADAAIAAAAUAAAA2gEFAAEAAABAAAAAAgEFAAEAAABIAAAAARIAAwABAAAAAQAAAASESgABAAAAAQAAAFQAAAAAAgAAAGQAAAAIAACACgAAAAEAAABaAAAAAQAADAAAAAEAAAAyMDI0OjA3OjEwIDE4OjM5OjE3AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRT/bAEMBAQEBAQGBwYEBgYICwsLEBYQERMUFRUVDA8XGBYUGBIUFRT/wgARCAAyADIDAREAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECA//EABYBAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAAA4cArlUigigKgoigigoigogoigKP/xAAbEAACAwEBAQAAAAAAAAAAAAACITEAERAgMf/aAAgBAQABPwDRx2I4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4jI4e+I/9sAhAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAAADAA-..',
                'BAC': 'https://upload.wikimedia.org/wikipedia/commons/c/cb/Bank_of_America_logo.svg',
                'RACE': 'https://upload.wikimedia.org/wikipedia/en/d/d1/Ferrari-Logo.svg',
                'NASDAQ': 'https://upload.wikimedia.org/wikipedia/commons/9/99/Nasdaq_logo.svg',
                'SP500': 'https://www.svgrepo.com/show/493033/graph-up.svg',
                'DAX': 'https://upload.wikimedia.org/wikipedia/commons/5/59/DAX_logo.svg',
                'JP225': 'https://upload.wikimedia.org/wikipedia/commons/9/92/Nikkei_225_Logo.svg',
                'EUR50': 'https://upload.wikimedia.org/wikipedia/commons/b/b7/Flag_of_Europe.svg',
                'COST': 'https://upload.wikimedia.org/wikipedia/commons/5/53/Costco_Wholesale_logo_2010-10-26.svg',
                'CAT': 'https://upload.wikimedia.org/wikipedia/commons/1/11/Caterpillar_logo.svg',
                'CRM': 'https://upload.wikimedia.org/wikipedia/commons/f/f9/Salesforce.com_logo.svg',
                'BX': 'https://upload.wikimedia.org/wikipedia/commons/b/b3/The_Blackstone_Group_logo.svg',
                'AMGN': 'https://upload.wikimedia.org/wikipedia/commons/c/c2/Amgen_logo.svg',
                'QCOM': 'https://upload.wikimedia.org/wikipedia/en/5/5d/Qualcomm_logo.svg'
            };

            // --- UI ELEMENTS ---
            const tabs = {
                dashboard: document.getElementById('tab-dashboard'),
                journal: document.getElementById('tab-journal'),
                analytics: document.getElementById('tab-analytics'),
            };
            const views = {
                dashboard: document.getElementById('view-dashboard'),
                journal: document.getElementById('view-journal'),
                analytics: document.getElementById('view-analytics'),
            };
            const modal = document.getElementById('trade-modal');
            const tradeForm = document.getElementById('trade-form');
            const assetSelect = document.getElementById('asset-select');
            const imageViewModal = document.getElementById('image-view-modal');
            const modalImageContent = document.getElementById('modal-image-content');
            const closeImageModalBtn = document.getElementById('close-image-modal-btn');
            
            // --- DATE HELPERS ---
            const frenchDays = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            const frenchMonths = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            
            function saveTrades() {
                localStorage.setItem('tradingJournalTrades', JSON.stringify(trades));
            }

            function switchView(view) {
                currentView = view;
                Object.values(views).forEach(v => v.classList.add('hidden'));
                Object.values(tabs).forEach(t => t.classList.remove('nav-title-active'));
                
                views[view].classList.remove('hidden');
                tabs[view].classList.add('nav-title-active');

                if (view === 'dashboard') renderDashboard();
                if (view === 'journal') renderJournal();
                if (view === 'analytics') renderAnalytics();
            }

            function getAssetLogo(assetName) {
                const cleanedName = assetName.replace('.B', '').replace(' ', '');
                if (logoMap[cleanedName]) {
                    return logoMap[cleanedName];
                }
                return `https://logo.clearbit.com/${cleanedName.toLowerCase()}.com`;
            }

            function renderDashboard() {
                const today = new Date();
                const dayName = frenchDays[today.getDay()];
                const monthName = frenchMonths[today.getMonth()];
                
                document.getElementById('dashboard-title').textContent = `(${dayName} ${today.getDate()} ${monthName})`;

                const tradableContainer = document.getElementById('tradable-assets');
                const nonTradableContainer = document.getElementById('non-tradable-assets');
                tradableContainer.innerHTML = '';
                nonTradableContainer.innerHTML = '';

                assetsData.sort((a,b) => a.name.localeCompare(b.name)).forEach(asset => {
                    const isTradable = asset.activeDays.includes(dayName) && !asset.inactiveMonths.includes(monthName);
                    const rebondsHTML = asset.rebonds && asset.rebonds !== 2 ? `<p><strong class="font-semibold">Rebonds:</strong> ${asset.rebonds}</p>` : '';
                    
                    const cardHTML = `
                        <div class="asset-card-wrapper" tabindex="0">
                            <div class="asset-card bg-gray-800 rounded-lg p-3 text-center ${isTradable ? 'border-2 border-blue-500' : 'opacity-40'}">
                                <img src="${getAssetLogo(asset.name)}" alt="Logo ${asset.name}" class="asset-logo h-10 w-10 mx-auto mb-2 rounded-full bg-white" onerror="this.onerror=null;this.src='https://placehold.co/40x40/FFFFFF/000000?text=${asset.name.charAt(0)}';">
                                <p class="font-semibold text-sm text-white">${asset.name}</p>
                            </div>
                            <div class="asset-tooltip bg-gray-900 border border-gray-700 text-white text-sm rounded-lg p-3 shadow-lg">
                                <p class="font-bold text-lg mb-2 text-blue-400">${asset.name}</p>
                                <p><strong class="font-semibold">RR:</strong> ${asset.rr}</p>
                                ${rebondsHTML}
                                <p class="mt-2"><strong class="font-semibold">Jours Actifs:</strong><br>${asset.activeDays.join(', ')}</p>
                                ${asset.inactiveMonths.length > 0 ? `<p class="mt-2"><strong class="font-semibold">Mois Inactifs:</strong><br>${asset.inactiveMonths.join(', ')}</p>` : ''}
                            </div>
                        </div>
                    `;
                    if (isTradable) {
                        tradableContainer.innerHTML += cardHTML;
                    } else {
                        nonTradableContainer.innerHTML += cardHTML;
                    }
                });
                setupTooltips();
            }
            
            function setupTooltips() {
                 document.querySelectorAll('.asset-card-wrapper').forEach(wrapper => {
                    const tooltip = wrapper.querySelector('.asset-tooltip');
                    const positionTooltip = () => {
                        const rect = wrapper.getBoundingClientRect();
                        tooltip.style.left = '50%';
                        tooltip.style.transform = 'translateX(-50%)';
                        const tooltipRect = tooltip.getBoundingClientRect();

                        if (tooltipRect.left < 0) {
                            tooltip.style.left = `${-rect.left}px`;
                            tooltip.style.transform = 'translateX(0)';
                        } else if (tooltipRect.right > window.innerWidth) {
                            tooltip.style.left = `auto`;
                            tooltip.style.right = `${window.innerWidth - rect.right - rect.width}px`;
                            tooltip.style.transform = 'translateX(0)';
                        }
                    };
                    wrapper.addEventListener('mouseenter', positionTooltip);
                    wrapper.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        positionTooltip();
                    });
                });
            }

            function getStatusBadge(status) {
                const statusMap = {
                    'tp': { label: 'TP', class: 'status-tp' },
                    'sl': { label: 'SL', class: 'status-sl' },
                    'be': { label: 'BE', class: 'status-be' },
                    'en-cours': { label: 'En Cours', class: 'status-en-cours' }
                };
                const config = statusMap[status];
                return `<span class="status-badge ${config.class}">${config.label}</span>`;
            }

            function renderJournal() {
                const currentTradesBody = document.getElementById('current-trades-body');
                const closedTradesBody = document.getElementById('closed-trades-body');
                currentTradesBody.innerHTML = '';
                closedTradesBody.innerHTML = '';
                
                const sortedTrades = [...trades].sort((a, b) => new Date(b.date) - new Date(a.date));

                if (sortedTrades.length === 0) {
                     currentTradesBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500">Aucun trade en cours. Cliquez sur "Ajouter un Trade" pour commencer.</td></tr>`;
                     closedTradesBody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-gray-500">Aucun trade dans l'historique.</td></tr>`;
                    return;
                }

                let hasCurrent = false;
                let hasClosed = false;

                sortedTrades.forEach(trade => {
                    if (trade.status === 'en-cours') {
                        hasCurrent = true;
                        const row = `
                            <tr class="trade-row" data-id="${trade.id}">
                                <td class="px-6 py-4 font-medium text-white">${trade.asset}</td>
                                <td class="px-6 py-4">${trade.date}</td>
                                <td class="px-6 py-4">${trade.time || 'N/A'}</td>
                                <td class="px-6 py-4">${trade.rr}</td>
                                <td class="px-6 py-4 truncate max-w-xs">${trade.notes || ''}</td>
                                <td class="px-6 py-4 text-right">
                                    <button class="font-medium text-blue-500 hover:underline mr-4 edit-btn">√âditer</button>
                                    <button class="font-medium text-red-500 hover:underline delete-btn">Supprimer</button>
                                </td>
                            </tr>
                        `;
                        currentTradesBody.innerHTML += row;
                    } else {
                        hasClosed = true;
                        const imageCellHTML = trade.image 
                            ? `<button data-image-src="${trade.image}" class="view-image-btn text-blue-500 hover:underline">Voir</button>` 
                            : 'N/A';
                        const row = `
                             <tr class="trade-row" data-id="${trade.id}">
                                <td class="px-6 py-4 font-medium text-white">${trade.asset}</td>
                                <td class="px-6 py-4">${trade.date}</td>
                                <td class="px-6 py-4">${getStatusBadge(trade.status)}</td>
                                <td class="px-6 py-4 font-bold ${trade.status === 'tp' ? 'text-green-400' : (trade.status === 'sl' ? 'text-red-400' : 'text-gray-400')}">${trade.status === 'tp' ? `+${trade.rr}` : (trade.status === 'sl' ? '-1' : '0')} R</td>
                                <td class="px-6 py-4 truncate max-w-xs">${trade.notes || ''}</td>
                                <td class="px-6 py-4">${imageCellHTML}</td>
                                <td class="px-6 py-4 text-right">
                                     <button class="font-medium text-blue-500 hover:underline mr-4 edit-btn">√âditer</button>
                                    <button class="font-medium text-red-500 hover:underline delete-btn">Supprimer</button>
                                </td>
                            </tr>
                        `;
                        closedTradesBody.innerHTML += row;
                    }
                });

                if (!hasCurrent) currentTradesBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500">Aucun trade en cours.</td></tr>`;
                if (!hasClosed) closedTradesBody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-gray-500">Aucun trade dans l'historique.</td></tr>`;
            }

            function renderMonthlyDetail(yearMonth, data) {
                document.getElementById('main-analytics-view').classList.add('hidden');
                document.getElementById('monthly-detail-view').classList.remove('hidden');

                const [year, month] = yearMonth.split('-');
                document.getElementById('monthly-detail-title').textContent = `Performance - ${frenchMonths[parseInt(month) - 1]} ${year}`;
                
                const monthTrades = data.trades;
                const wins = monthTrades.filter(t => t.status === 'tp').length;
                const winRate = monthTrades.length > 0 ? (wins / monthTrades.length) * 100 : 0;
                document.getElementById('monthly-analytics-winrate').textContent = `${winRate.toFixed(1)}%`;
                document.getElementById('monthly-analytics-total-r').textContent = `${data.totalR.toFixed(2)} R`;
                const winningTrades = monthTrades.filter(t => t.status === 'tp');
                const avgRR = winningTrades.length > 0 ? winningTrades.reduce((acc, t) => acc + parseFloat(t.rr), 0) / winningTrades.length : 0;
                document.getElementById('monthly-analytics-avg-rr').textContent = avgRR.toFixed(2);

                const dailyData = {};
                monthTrades.forEach(trade => {
                    const day = trade.date.split('-')[2];
                    if(!dailyData[day]) dailyData[day] = 0;
                    let rValue = 0;
                    if (trade.status === 'tp') rValue = parseFloat(trade.rr);
                    if (trade.status === 'sl') rValue = -1;
                    dailyData[day] += rValue;
                });

                const sortedDays = Object.keys(dailyData).sort((a,b) => parseInt(a) - parseInt(b));
                const dailyLabels = sortedDays.map(day => `${day}/${month}`);
                const dailyChartData = sortedDays.map(day => dailyData[day]);
                
                const ctx = document.getElementById('daily-capital-chart').getContext('2d');
                if (dailyCapitalChart) dailyCapitalChart.destroy();
                dailyCapitalChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: dailyLabels, datasets: [{
                            label: 'Gain/Perte en R',
                            data: dailyChartData,
                            backgroundColor: dailyChartData.map(val => val >= 0 ? 'rgba(16, 185, 129, 0.6)' : 'rgba(234, 179, 8, 0.6)'),
                            borderColor: dailyChartData.map(val => val >= 0 ? '#10b981' : '#eab308'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: { y: { beginAtZero: true, ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } },
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (context) => `${context.parsed.y.toFixed(2)} R` } } }
                    }
                });
            }

            function renderAnalytics() {
                document.getElementById('main-analytics-view').classList.remove('hidden');
                document.getElementById('monthly-detail-view').classList.add('hidden');

                const closedTrades = trades.filter(t => t.status !== 'en-cours');

                if (closedTrades.length === 0) {
                    document.getElementById('analytics-winrate').textContent = 'N/A';
                    document.getElementById('analytics-total-r').textContent = '0 R';
                    document.getElementById('analytics-avg-rr').textContent = '0';
                    if (capitalChart) { capitalChart.destroy(); capitalChart = null; }
                    const ctx = document.getElementById('capital-chart').getContext('2d');
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    return;
                }

                const wins = closedTrades.filter(t => t.status === 'tp').length;
                const winRate = (wins / closedTrades.length) * 100;
                document.getElementById('analytics-winrate').textContent = `${winRate.toFixed(1)}%`;
                const totalR = closedTrades.reduce((acc, trade) => {
                    if (trade.status === 'tp') return acc + parseFloat(trade.rr);
                    if (trade.status === 'sl') return acc - 1;
                    return acc;
                }, 0);
                document.getElementById('analytics-total-r').textContent = `${totalR.toFixed(2)} R`;
                const winningTrades = closedTrades.filter(t => t.status === 'tp');
                const avgRR = winningTrades.length > 0 ? winningTrades.reduce((acc, t) => acc + parseFloat(t.rr), 0) / winningTrades.length : 0;
                document.getElementById('analytics-avg-rr').textContent = avgRR.toFixed(2);
                
                const monthlyData = {};
                closedTrades.forEach(trade => {
                    const date = new Date(trade.date);
                    const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyData[yearMonth]) { monthlyData[yearMonth] = { totalR: 0, trades: [] }; }
                    let rValue = 0;
                    if (trade.status === 'tp') rValue = parseFloat(trade.rr);
                    if (trade.status === 'sl') rValue = -1;
                    monthlyData[yearMonth].totalR += rValue;
                    monthlyData[yearMonth].trades.push(trade);
                });

                const sortedMonths = Object.keys(monthlyData).sort();
                const chartLabels = sortedMonths.map(key => {
                    const [year, month] = key.split('-');
                    return `${frenchMonths[parseInt(month) - 1]} ${year}`;
                });
                const chartData = sortedMonths.map(key => monthlyData[key].totalR);
                
                const ctx = document.getElementById('capital-chart').getContext('2d');
                if (capitalChart) capitalChart.destroy();
                capitalChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: chartLabels, datasets: [{
                            label: 'Gain/Perte en R',
                            data: chartData,
                            backgroundColor: chartData.map(val => val >= 0 ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)'),
                            borderColor: chartData.map(val => val >= 0 ? '#10b981' : '#ef4444'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                       scales: { y: { beginAtZero: false, ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } },
                       plugins: { legend: { display: false }, tooltip: { callbacks: { label: (context) => `${context.parsed.y.toFixed(2)} R` } } },
                       onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const yearMonth = sortedMonths[index];
                                renderMonthlyDetail(yearMonth, monthlyData[yearMonth]);
                            }
                        }
                    }
                });
            }

            function openModal(trade = null) {
                tradeForm.reset();
                const imagePreview = document.getElementById('image-preview');
                imagePreview.classList.add('hidden');
                imagePreview.src = '';
                
                if (trade) {
                    document.getElementById('modal-title').textContent = '√âditer le trade';
                    document.getElementById('trade-id').value = trade.id;
                    document.getElementById('asset-select').value = trade.asset;
                    document.getElementById('trade-date').value = trade.date;
                    document.getElementById('trade-time').value = trade.time;
                    document.getElementById('trade-status').value = trade.status;
                    document.getElementById('trade-rr').value = trade.rr;
                    document.getElementById('trade-notes').value = trade.notes;
                    document.getElementById('trade-image-base64').value = trade.image;
                    if(trade.image) {
                        imagePreview.src = trade.image;
                        imagePreview.classList.remove('hidden');
                    }
                } else {
                     document.getElementById('modal-title').textContent = 'Ajouter un nouveau trade';
                     document.getElementById('trade-id').value = '';
                     document.getElementById('trade-date').value = new Date().toISOString().split('T')[0];
                     const now = new Date();
                     document.getElementById('trade-time').value = now.toTimeString().slice(0,5);
                }
                modal.classList.remove('hidden');
            }

            function closeModal() {
                modal.classList.add('hidden');
            }

            function closeImageModal() {
                imageViewModal.classList.add('hidden');
                modalImageContent.src = '';
            }

            function handleFormSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('trade-id').value;
                const tradeData = {
                    asset: document.getElementById('asset-select').value,
                    date: document.getElementById('trade-date').value,
                    time: document.getElementById('trade-time').value,
                    status: document.getElementById('trade-status').value,
                    rr: parseFloat(document.getElementById('trade-rr').value),
                    notes: document.getElementById('trade-notes').value,
                    image: document.getElementById('trade-image-base64').value,
                };

                if (id) {
                    const index = trades.findIndex(t => t.id == id);
                    trades[index] = { ...trades[index], ...tradeData };
                } else {
                    tradeData.id = Date.now();
                    trades.push(tradeData);
                }
                
                saveTrades();
                renderJournal();
                closeModal();
            }

            // --- EVENT LISTENERS ---
            Object.keys(tabs).forEach(key => {
                tabs[key].addEventListener('click', () => switchView(key));
            });

            document.getElementById('add-trade-btn').addEventListener('click', () => openModal());
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
            tradeForm.addEventListener('submit', handleFormSubmit);

            closeImageModalBtn.addEventListener('click', closeImageModal);
            imageViewModal.addEventListener('click', (e) => {
                if (e.target === imageViewModal) {
                    closeImageModal();
                }
            });

            document.getElementById('back-to-main-analytics').addEventListener('click', () => {
                document.getElementById('monthly-detail-view').classList.add('hidden');
                document.getElementById('main-analytics-view').classList.remove('hidden');
            });

             document.getElementById('trade-image-file').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('trade-image-base64').value = e.target.result;
                        const preview = document.getElementById('image-preview');
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('view-journal').addEventListener('click', (e) => {
                 const target = e.target;
                 const row = target.closest('tr');
                 if (!row) return;
                 const id = row.dataset.id;
                 
                 if (target.classList.contains('edit-btn')) {
                     const trade = trades.find(t => t.id == id);
                     openModal(trade);
                 }
                 
                 if (target.classList.contains('delete-btn')) {
                     if (confirm('√ätes-vous s√ªr de vouloir supprimer ce trade ?')) {
                         trades = trades.filter(t => t.id != id);
                         saveTrades();
                         renderJournal();
                         renderAnalytics(); // Update analytics after deleting
                     }
                 }

                 if (target.classList.contains('view-image-btn')) {
                    const imgSrc = target.dataset.imageSrc;
                    if (imgSrc) {
                        modalImageContent.src = imgSrc;
                        imageViewModal.classList.remove('hidden');
                    }
                }
            });

            // --- INITIALIZATION ---
            assetsData.sort((a,b) => a.name.localeCompare(b.name)).forEach(asset => {
                const option = document.createElement('option');
                option.value = asset.name;
                option.textContent = asset.name;
                assetSelect.appendChild(option);
            });

            switchView('dashboard');
        });
    </script>
</body>
</html>

